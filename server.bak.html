import express, { Request, Response } from "express";
import { Card } from "./model/Card";
import { ThumbnailGenerator } from "./model/ThumbnailGenerator";
import path from "path";
import { PostViewModel } from "../viewModels/PostVm";
import { Post } from "./model/Post";
import { PostRepository } from "./repositories/PostRepository";
import { database } from "./model/fakeDB";
import { UserRepository } from "./repositories/UserRepository";
import { User } from "./model/User";

const app = express();

// Configure Express to use EJS
app.use(express.static(path.join(__dirname, "public")));
app.use(express.urlencoded({ extended: true }));
app.set("views", path.join(__dirname, "views"));
app.set("view engine", "ejs");

// app.get("/", async (req: Request, res: Response) => {
//   let card = new Card(
//     "mock title",
//     "mock description",
//     "www.theverge.com",
//     new ThumbnailGenerator("dev.to")
//   );

//   res.render("index", {
//     cardList: [
//       {
//         cardTitle: card.cardTitle,
//         cardDescription: card.cardDescription,
//         cardImage: await card.coverImage,
//       },
//     ],
//   });
// });

/*
app.get("/addSite", (req: Request, res: Response) => {
  res.render("addSite");
});

app.get("/users/james123", (_, res: Response) => {
  let postRepository = new PostRepository();
  let postList = postRepository.getPosts("james123");
  let userRepo = new UserRepository();
  let isFollowing = userRepo.isFollowing("james123", "john123");
  console.log(isFollowing);
  let postViewModels = postList.map((post) => {
    return new PostViewModel(
      "hi",
      "james123",
      post.createdAt,
      post.message,
      post.comments.toString(),
      post.reposts.toString(),
      post.likes.toString()
    );
  });
  res.render("newsfeedExternal", {
    posts: postViewModels,
    isFollowing,
    currentFeedUser: "james123",
  });
});

app.post("/follow/:username", (req: Request, res: Response) => {
  const userToFollow = req.params["username"];
  const userRepo = new UserRepository();
  userRepo.followUser(userToFollow, "john123");
  res.redirect("/users/james123");
});

app.post("/unfollow/:username", (req: Request, res: Response) => {
  const userToUnfollow = req.params["username"];
  const userRepo = new UserRepository();
  userRepo.unfollowUser(userToUnfollow, "john123");
  res.redirect("/users/james123");
});

app.get("/login", (req: Request, res: Response) => {
  res.render("login");
});
*/
// app.post("/login", (req: Request, res: Response) => {
//   const { username, password } = req.body;
//   const user = new User("Jim", "Smith", username, password);
//   res.redirect("/users/james123");
// });

app.get("/register", (req: Request, res: Response) => {
  res.render("register");
});

// app.post("/register", (req: Request, res: Response) => {
//   const { username, password } = req.body;
//   const user = new User("Jim", "Smith", username, password);
//   res.redirect("/users/james123");
// });

app.get("/feed", (_, res: Response) => {
  let postRepository = new PostRepository();
 // let postList = postRepository.getPosts("john123");
  //let externalPosts = postRepository.getPosts("james123");

 // let postViewModels = [...postList, ...externalPosts].map((post) => {
//     return new PostViewModel(
//       "hi",

//       "john123",
//       post.createdAt,
//       post.message,
//       post.comments.toString(),
//       post.reposts.toString(),
//       post.likes.toString()
//     );
//   });

//   res.render("newsfeed", { posts: postViewModels });
// });

// app.post("/posts", (req: Request, res: Response) => {
//   console.log(database.users["john123"].posts.length);
//   let { postText } = req.body;
//   console.log(postText);
//   let post = new Post(postText, "Dec 15, 2020", 0, 0, 0);
//   let postRepository = new PostRepository();
//   postRepository.addPost(post, "john123");
//   res.redirect("/feed");
//   console.log(database.users["john123"].posts.length);
// });

/*

app.post("/addSite", async (req: Request, res: Response) => {
  let { siteUrl, siteTitle, siteDescription } = req.body;
  let card = new Card(
    siteTitle,
    siteDescription,
    siteUrl,
    new ThumbnailGenerator(siteUrl)
  );

  await card.initializeCoverImage();

  return res.render("index", {
    cardList: [card],
  });
});

app.get("/posts/1/comments", (_, res) => {
  res.render("comments");
});

app.get("/makePost", async (req: Request, res: Response) => {
  res.render("makePost");
});

app.listen(5000, () => {
  console.log("server running on port 5000");
})
*/